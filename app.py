import streamlit as st
import pandas as pd
import os
from io import BytesIO

# ==========================
# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š
# ==========================
st.set_page_config(page_title="à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ à¸²à¸©à¸µà¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™", layout="wide")
st.title("ğŸ“‘ à¸£à¸°à¸šà¸šà¸£à¸²à¸¢à¸‡à¸²à¸™à¸ à¸²à¸©à¸µà¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™")

DATA_FILE = "sales_daily.xlsx"

COLUMNS = [
    "à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­", "à¸¥à¸³à¸”à¸±à¸š", "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š", "Seller",
    "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­/à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²", "à¸£à¸«à¸±à¸ª", "à¸ªà¸µ", "Size",
    "à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢", "à¸ªà¹ˆà¸§à¸™à¸¥à¸”", "à¸ªà¸¸à¸—à¸˜à¸´", "à¸§.à¸”.à¸›.", "à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™",
    "à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸à¸—à¸¡.", "à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸•à¸ˆà¸§.", "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸­à¸™", "à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"
]

# ==========================
# à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸«à¸£à¸·à¸­à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ)
# ==========================
if os.path.exists(DATA_FILE):
    try:
        df = pd.read_excel(DATA_FILE)
    except Exception:
        df = pd.DataFrame(columns=COLUMNS)
else:
    df = pd.DataFrame(columns=COLUMNS)

for col in COLUMNS:
    if col not in df.columns:
        df[col] = ""

# ==========================
# à¹€à¸à¹‡à¸š index à¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚à¹ƒà¸™ session
# ==========================
if "edit_index" not in st.session_state:
    st.session_state.edit_index = None

# ==========================
# à¸Ÿà¸­à¸£à¹Œà¸¡à¸à¸£à¸­à¸ / à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
# ==========================
st.subheader("ğŸ§¾ à¸à¸£à¸­à¸à¸«à¸£à¸·à¸­à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥")

edit_mode = st.session_state.edit_index is not None
form_title = "âœï¸ à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥" if edit_mode else "â• à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆ"
st.markdown(f"### {form_title}")

if edit_mode:
    row = df.iloc[st.session_state.edit_index]
else:
    row = {col: "" for col in COLUMNS}

with st.form("sales_form"):
    col1, col2, col3 = st.columns(3)

    with col1:
        à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­ = st.date_input("à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­", pd.to_datetime(row["à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­"]) if row["à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­"] else None)
        à¸¥à¸³à¸”à¸±à¸š = st.number_input("à¸¥à¸³à¸”à¸±à¸š", min_value=1, step=1, value=int(row["à¸¥à¸³à¸”à¸±à¸š"]) if str(row["à¸¥à¸³à¸”à¸±à¸š"]).isdigit() else 1)
        à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š = st.text_input("à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š", row["à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š"])
        Seller = st.selectbox("Seller", ["shopee", "lazada", "cent", "à¸­à¸·à¹ˆà¸™à¹†"], index=0 if row["Seller"] == "" else ["shopee", "lazada", "cent", "à¸­à¸·à¹ˆà¸™à¹†"].index(row["Seller"]))
        à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­ = st.text_input("à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­/à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²", row["à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­/à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²"])

    with col2:
        à¸£à¸«à¸±à¸ª = st.text_input("à¸£à¸«à¸±à¸ª", row["à¸£à¸«à¸±à¸ª"])
        à¸ªà¸µ = st.text_input("à¸ªà¸µ", row["à¸ªà¸µ"])
        Size = st.text_input("Size", row["Size"])
        à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢ = st.number_input("à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢", min_value=0.0, value=float(row["à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢"]) if row["à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢"] else 0.0)
        à¸ªà¹ˆà¸§à¸™à¸¥à¸” = st.number_input("à¸ªà¹ˆà¸§à¸™à¸¥à¸”", min_value=0.0, value=float(row["à¸ªà¹ˆà¸§à¸™à¸¥à¸”"]) if row["à¸ªà¹ˆà¸§à¸™à¸¥à¸”"] else 0.0)
        à¸ªà¸¸à¸—à¸˜à¸´ = st.number_input("à¸ªà¸¸à¸—à¸˜à¸´", min_value=0.0, value=float(row["à¸ªà¸¸à¸—à¸˜à¸´"]) if row["à¸ªà¸¸à¸—à¸˜à¸´"] else 0.0)

    with col3:
        à¸§à¸”à¸› = st.date_input("à¸§.à¸”.à¸›.", pd.to_datetime(row["à¸§.à¸”.à¸›."]) if row["à¸§.à¸”.à¸›."] else None)
        à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ = st.number_input("à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™", min_value=0.0, value=float(row["à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™"]) if row["à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™"] else 0.0)
        à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡à¸à¸—à¸¡ = st.number_input("à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸à¸—à¸¡.", min_value=0.0, value=float(row["à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸à¸—à¸¡."]) if row["à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸à¸—à¸¡."] else 0.0)
        à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡à¸•à¸ˆà¸§ = st.number_input("à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸•à¸ˆà¸§.", min_value=0.0, value=float(row["à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸•à¸ˆà¸§."]) if row["à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸•à¸ˆà¸§."] else 0.0)
        à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸­à¸™ = st.text_input("à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸­à¸™", row["à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸­à¸™"])

    st.markdown("### ğŸ“ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸")
    à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ = st.selectbox("à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸", ["", "à¸„à¸·à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²", "à¸à¸±à¸ªà¸”à¸¸à¸•à¸µà¸à¸¥à¸±à¸š", "à¸¢à¸à¹€à¸¥à¸´à¸à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ", "à¸­à¸·à¹ˆà¸™à¹†"], index=0 if not row["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"] else
        ["", "à¸„à¸·à¸™à¸ªà¸´à¸™à¸„à¹‰à¸²", "à¸à¸±à¸ªà¸”à¸¸à¸•à¸µà¸à¸¥à¸±à¸š", "à¸¢à¸à¹€à¸¥à¸´à¸à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ", "à¸­à¸·à¹ˆà¸™à¹†"].index(row["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"].split(" - ")[0] if " - " in row["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"] else row["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"]))
    à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ = ""
    if à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸:
        à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ = st.text_area("à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡", row["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"].split(" - ")[1] if " - " in row["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"] else "")

    submitted = st.form_submit_button("ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸")
    cancelled = st.form_submit_button("âŒ à¸¢à¸à¹€à¸¥à¸´à¸")

if submitted:
    new_row = {
        "à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­": à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­,
        "à¸¥à¸³à¸”à¸±à¸š": à¸¥à¸³à¸”à¸±à¸š,
        "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š": à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š,
        "Seller": Seller,
        "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­/à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²": à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­,
        "à¸£à¸«à¸±à¸ª": à¸£à¸«à¸±à¸ª,
        "à¸ªà¸µ": à¸ªà¸µ,
        "Size": Size,
        "à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢": à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢,
        "à¸ªà¹ˆà¸§à¸™à¸¥à¸”": à¸ªà¹ˆà¸§à¸™à¸¥à¸”,
        "à¸ªà¸¸à¸—à¸˜à¸´": à¸ªà¸¸à¸—à¸˜à¸´,
        "à¸§.à¸”.à¸›.": à¸§à¸”à¸›,
        "à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™": à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™,
        "à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸à¸—à¸¡.": à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡à¸à¸—à¸¡,
        "à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡ à¸•à¸ˆà¸§.": à¸„à¹ˆà¸²à¸‚à¸™à¸ªà¹ˆà¸‡à¸•à¸ˆà¸§,
        "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸­à¸™": à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¹‚à¸­à¸™,
        "à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸": f"{à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸} - {à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡}" if à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸ else ""
    }

    if edit_mode:
        df.iloc[st.session_state.edit_index] = new_row
        st.success("âœ… à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§!")
        st.session_state.edit_index = None
    else:
        df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
        st.success("âœ… à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§!")

    df.sort_values(by="à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­", ascending=True, inplace=True)
    df.to_excel(DATA_FILE, index=False)
    st.experimental_rerun()

if cancelled:
    st.session_state.edit_index = None
    st.experimental_rerun()

# ==========================
# à¸•à¸²à¸£à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸­à¹ˆà¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸”à¸µà¸¢à¸§)
# ==========================
st.subheader("ğŸ“‹ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”")

if len(df) > 0:
    for i, row in df.iterrows():
        with st.container(border=True):
            cols = st.columns([2, 3, 2, 2, 3, 2, 1])
            cols[0].write(f"ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­: {row['à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­']}")
            cols[1].write(f"ğŸ’¬ à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­: {row['à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­/à¸Šà¸·à¹ˆà¸­à¸¥à¸¹à¸à¸„à¹‰à¸²']}")
            cols[2].write(f"ğŸ§¾ à¹ƒà¸šà¸à¸³à¸à¸±à¸š: {row['à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸šà¸à¸³à¸à¸±à¸š']}")
            cols[3].write(f"ğŸ’¸ à¸ªà¸¸à¸—à¸˜à¸´: {row['à¸ªà¸¸à¸—à¸˜à¸´']}")
            cols[4].write(f"ğŸ·ï¸ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: {row['à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸']}")
            if cols[5].button("âœï¸ à¹à¸à¹‰à¹„à¸‚", key=f"edit_{i}"):
                st.session_state.edit_index = i
                st.experimental_rerun()
            if cols[6].button("ğŸ—‘ï¸ à¸¥à¸š", key=f"delete_{i}"):
                df = df.drop(i).reset_index(drop=True)
                df.to_excel(DATA_FILE, index=False)
                st.experimental_rerun()
else:
    st.info("à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸£à¸°à¸šà¸š")

# ==========================
# à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ
# ==========================
st.download_button(
    label="ğŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Excel",
    data=df.to_excel(index=False, engine="openpyxl"),
    file_name="sales_daily.xlsx",
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
)
